{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/register.css' %}">
{% endblock %}

{% block content %}
<!-- Facebook SDK Root -->
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v22.0&appId=2065671450512648"></script>

<div class="register-form">
    <h2>Register</h2>

    <!-- Facebook Registration Option -->
    <div class="form-group">
        <!-- Facebook Login Button -->
        <div class="fb-login-button"
             data-width=""
             data-size="large"
             data-button-type="continue_with"
             data-layout="default"
             data-auto-logout-link="false"
             data-use-continue-as="true"
             scope="public_profile,email"
             onlogin="checkLoginState();">
        </div>
        <p>(We'll never post on your timeline without your permission)</p>
    </div>

    <form method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}
        {{ form.non_field_errors }} <!-- Display non-field errors here -->

        <div class="form-group">
            <label for="{{ form.first_name.id_for_label }}">First Name:</label>
            {{ form.first_name }}
            {{ form.first_name.errors }}
        </div>

        <div class="form-group">
            <label for="{{ form.last_name.id_for_label }}">Last Name:</label>
            {{ form.last_name }}
            {{ form.last_name.errors }}
        </div>

        <div class="form-group">
            <label for="{{ form.email.id_for_label }}">Email:</label>
            {{ form.email }}
            {{ form.email.errors }}
        </div>

        <div class="form-group">
            <label for="{{ form.password1.id_for_label }}">Password:</label>
            {{ form.password1 }}
            {{ form.password1.errors }}
        </div>

        <div class="form-group">
            <label for="{{ form.password2.id_for_label }}">Confirm Password:</label>
            {{ form.password2 }}
            {{ form.password2.errors }}
        </div>

        <!-- Gender Selection -->
        <div class="form-group">
            <label>Gender:</label><br>
            <label><input type="radio" name="gender" value="male" required> Male</label><br>
            <label><input type="radio" name="gender" value="female" required> Female</label><br>
            <label><input type="radio" name="gender" value="other" required> Other</label>
            <input type="text" name="gender_other" id="gender_other" placeholder="Please specify" style="display:none;">
            <br>
            <label><input type="radio" name="gender" value="prefer_not_to_say" required> Prefer not to say</label>
        </div>

        <div class="form-group">
            <label>Date of Birth:</label>
            <div class="dob-container">
                <select name="dob_day" required>
                    <option value="" disabled selected>DD</option>
                    {% for day in days %}
                        <option value="{{ day }}">{{ day }}</option>
                    {% endfor %}
                </select>
                <select name="dob_month" required>
                    <option value="" disabled selected>MM</option>
                    {% for month in months %}
                        <option value="{{ month }}">{{ month }}</option>
                    {% endfor %}
                </select>
                <select name="dob_year" required>
                    <option value="" disabled selected>YYYY</option>
                    {% for year in years %}
                        <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <p>You must be 18 or over to use Trusted Lodger</p>
        </div>

        <!-- User Status Checkboxes -->
        <div class="form-group">
            <label>Tick those which apply to you:</label><br>
            <label><input type="checkbox" name="user_status" value="looking_for_share"> I am looking for a flat or house share</label><br>
            <label><input type="checkbox" name="user_status" value="have_share"> I have a flat or house share</label><br>
            <label><input type="checkbox" name="user_status" value="find_people"> I'd like to find people to form a new share</label>
            <div class="error" id="status-error" style="display:none;">Please select at least one option.</div>
        </div>

        <!-- Profile Picture Upload -->
        <div class="form-group">
            <label for="profile_picture">Upload a Profile Picture (optional):</label>
            <input type="file" name="profile_picture" id="profile_picture" accept="image/*">
        </div>

        <button type="submit" class="btn btn-primary">Register now</button>
        <p>* By clicking Register now you agree to Trusted Lodger's terms and privacy policy. We will send you emails as part of the services we provide to you. You can unsubscribe at any time via the website or the link in the emails.</p>

        <!-- reCAPTCHA -->
        <div class="g-recaptcha" data-sitekey="YOUR_SITE_KEY"></div> <!-- Replace with your reCAPTCHA site key -->
    </form>

    <p>Already have an account? <a href="{% url 'accounts:login' %}">Login here</a>.</p>
</div>

<script>
    // Facebook SDK Initialization
    window.fbAsyncInit = function() {
        FB.init({
            appId: '2065671450512648', // Replace with your app ID
            cookie: true,
            xfbml: true,
            version: 'v22.0'
        });
        FB.AppEvents.logPageView();
    };

    // Check Facebook login state
    function checkLoginState() {
        FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
        });
    }

    // Handle Facebook login status
    function statusChangeCallback(response) {
        if (response.status === 'connected') {
            // User is logged into Facebook and your app
            console.log('User is logged in:', response);
            // Redirect to logged-in experience
            window.location.href = '/accounts/facebook-login-success/';
        } else {
            // User is not logged in
            console.log('User is not logged in:', response);
        }
    }

    // Show the gender input field if "Other" is selected
    document.querySelectorAll('input[name="gender"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
            const otherInput = document.getElementById('gender_other');
            if (event.target.value === 'other') {
                otherInput.style.display = 'inline';
            } else {
                otherInput.style.display = 'none';
                otherInput.value = ''; // Clear the input if not selected
            }
        });
    });

    // Validate the form before submission
    function validateForm() {
        const checkboxes = document.querySelectorAll('input[name="user_status"]');
        const errorElement = document.getElementById('status-error');
        let isChecked = false;
        checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
                isChecked = true;
            }
        });
        if (!isChecked) {
            errorElement.style.display = 'block';
            return false;
        }
        return true;
    }
</script>
{% endblock %}